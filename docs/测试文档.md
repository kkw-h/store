# 项目测试文档

本文档详细描述了项目的测试策略、环境搭建、测试用例以及如何运行测试。

## 1. 测试策略

本项目主要采用 **集成测试 (Integration Testing)** 的策略，针对 API 接口进行端到端的测试。

*   **测试框架**: `pytest`
*   **异步支持**: `pytest-asyncio`
*   **HTTP 客户端**: `httpx.AsyncClient`
*   **数据库**: 使用与开发环境相同的 PostgreSQL 数据库（建议在 CI/CD 中使用独立的测试数据库）。

## 2. 测试环境搭建

### 2.1 依赖安装

确保已安装 `requirements.txt` 中的所有依赖，包括测试相关的库：

```bash
pip install pytest pytest-asyncio httpx
```

### 2.2 数据库配置

测试代码默认读取 `app/core/config.py` 中的数据库配置。
在 `tests/conftest.py` 中，我们创建了一个 `TestingSessionLocal`，并通过 `dependency_overrides` 覆盖了 FastAPI 的 `get_db` 依赖，确保测试期间使用受控的数据库会话。

## 3. 测试用例结构

测试代码位于 `tests/` 目录下，按模块划分：

*   `tests/conftest.py`: 全局 Fixtures（数据库连接、HTTP客户端、Token获取）。
*   `tests/test_auth.py`: 用户认证模块测试（微信登录、手机号登录）。
*   `tests/test_address.py`: 地址管理模块测试（增删改查）。
*   `tests/test_product.py`: 商品与分类模块测试（分类创建、商品上架、列表查询）。
*   `tests/test_order.py`: 订单流程测试（预览、下单、列表、详情）及商家管理流程（接单、核销）。

## 4. 详细测试流程

### 4.1 认证模块 (`test_auth.py`)
*   **微信登录**: 模拟 `code` 换取 Token，验证返回结构。
*   **手机号登录**: 验证手机号+验证码登录逻辑。
*   **异常处理**: 验证无效验证码的错误响应。

### 4.2 地址模块 (`test_address.py`)
*   **创建与列表**: 创建新地址并验证列表能否查询到。
*   **更新**: 修改地址信息及默认状态，验证更新结果。
*   **删除**: 删除地址并验证。

### 4.3 商品模块 (`test_product.py`)
*   **完整流程**: 创建分类 -> 创建商品 -> 按分类查询商品列表 -> 查看商品详情 -> 更新商品信息。

### 4.4 订单与商家模块 (`test_order.py`)
*   **用户下单流程**:
    1.  商品/地址准备。
    2.  **订单预检**: 验证运费计算逻辑（满30免邮）。
    3.  **创建订单**: 提交订单，验证库存扣减（逻辑层面）。
    4.  **订单查询**: 验证订单列表和详情包含正确的时间轴和状态。
*   **商家管理流程**:
    1.  创建订单。
    2.  **商家接单**: 调用 `/admin/order/audit`，验证状态流转。
    3.  **确认送达**: 调用 `/admin/order/complete_delivery`。
    4.  **店铺配置**: 验证店铺营业时间设置接口。

## 5. 如何运行测试

在 `store-api` 目录下执行以下命令：

```bash
# 运行所有测试
pytest tests

# 运行所有测试并显示详细信息
pytest tests -v

# 运行指定文件的测试
pytest tests/test_order.py -v

# 遇到错误停止
pytest -x tests
```

## 6. 注意事项

1.  **数据清理**: 当前测试运行在开发数据库上，虽然不会清空现有数据，但会产生测试垃圾数据。建议定期清理或配置专门的测试数据库。
2.  **Mock 数据**: 微信 API 调用和支付接口目前在代码中已通过 Mock 逻辑处理（如 `code="mock_code"`），测试代码依赖这些 Mock 行为。
